<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Currys SKU Quick Link</title>
  <style>
    :root{--bg:#fafafa;--fg:#111;--muted:#666;--border:#d0d7de}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:grid;place-items:center;min-height:100vh;margin:0;background:var(--bg)}
    .card{background:white;padding:24px 20px;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);width:min(760px,94vw)}
    h1{font-size:20px;margin:0 0 8px}
    p{margin:0 0 12px;color:#444}
    form{display:flex;gap:8px}
    input[type=text]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);font-size:16px}
    button{padding:12px 16px;border-radius:12px;border:0;background:var(--fg);color:#fff;font-size:16px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .box{border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:16px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .linkline{display:flex;gap:8px}
    .linkline input{flex:1}
    .small{font-size:12px;color:var(--muted)}
    details{margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Currys SKU → Short Link + QR</h1>
    <p>Enter a SKU. This builds a DuckDuckGo <code>!ducky</code> direct link to <code>currys.co.uk/products</code>, shortens it with TinyURL, and gives you a QR.</p>

    <form id="f">
      <input id="sku" type="text" inputmode="numeric" autocomplete="off" placeholder="e.g. 512013" autofocus />
      <button id="go" type="submit">Generate</button>
    </form>

    <div id="out" style="display:none">
      <div class="box">
        <div class="label">Shortened direct product link</div>
        <div class="linkline">
          <input id="shortUrl" type="text" readonly>
          <button type="button" data-copy="#shortUrl">Copy</button>
          <a id="openShort" target="_blank" rel="noopener"><button type="button">Open</button></a>
        </div>
        <div class="small" style="margin-top:8px">QR code link: <a id="qrLink" target="_blank" rel="noopener">Open QR</a></div>
      </div>

      <details>
        <summary>Bookmarklet</summary>
        <p>Drag to bookmarks. Prompts for a SKU, then creates a TinyURL to the direct product result.</p>
        <p><a id="bm" href="#">Currys SKU → Short Link</a></p>
      </details>

      <details>
        <summary>Show underlying target (for debugging)</summary>
        <div class="box">
          <div class="label">Raw target URL used for shortening</div>
          <div class="linkline">
            <input id="rawUrl" type="text" readonly>
            <button type="button" data-copy="#rawUrl">Copy</button>
            <a id="openRaw" target="_blank" rel="noopener"><button type="button">Open</button></a>
          </div>
          <div class="small" style="margin-top:8px">Includes <code>!ducky</code> and excludes Currys Business.</div>
        </div>
      </details>
    </div>
  </div>

  <script>
    const f = document.getElementById('f');
    const skuInput = document.getElementById('sku');
    const out = document.getElementById('out');

    const shortUrl = document.getElementById('shortUrl');
    const openShort = document.getElementById('openShort');
    const qrLink = document.getElementById('qrLink');

    const rawUrl = document.getElementById('rawUrl');
    const openRaw = document.getElementById('openRaw');

    const bm = document.getElementById('bm');

    function buildTarget(sku){
      const clean = (sku||'').trim();
      if(!clean) return null;
      // Force direct jump to product page using !ducky. Filter Business.
      return `https://duckduckgo.com/?q=!ducky+site%3Acurrys.co.uk%2Fproducts+${encodeURIComponent(clean)}+-site%3Abusiness.currys.co.uk+-site%3Acurrysbusiness.co.uk`;
    }

    async function shorten(url){
      const api = `https://tinyurl.com/api-create.php?url=${encodeURIComponent(url)}`;
      try{
        const res = await fetch(api, { mode: 'cors' });
        const txt = await res.text();
        return txt.startsWith('http') ? txt : url; // fallback to raw if shortening fails
      }catch(e){
        return url; // fallback
      }
    }

    function setBookmarklet(){
      const code = "javascript:(async function(){var s=prompt('Currys SKU?');if(!s)return;var u='https://duckduckgo.com/?q=!ducky+site%3Acurrys.co.uk%2Fproducts+'+encodeURIComponent(s)+'+-site%3Abusiness.currys.co.uk+-site%3Acurrysbusiness.co.uk';var a='https://tinyurl.com/api-create.php?url='+encodeURIComponent(u);try{var r=await fetch(a);var t=await r.text();location.href=(t.indexOf('http')===0?t:u);}catch(e){location.href=u;}})();";
      bm.href = code;
    }

    async function updateUI(target){
      rawUrl.value = target;
      openRaw.href = target;

      const short = await shorten(target);
      shortUrl.value = short;
      openShort.href = short;
      qrLink.href = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(short)}`;

      out.style.display = 'block';
    }

    function copySel(selector){
      const el = document.querySelector(selector);
      el.select();
      el.setSelectionRange(0, 99999);
      try{document.execCommand('copy');}catch(e){
        navigator.clipboard && navigator.clipboard.writeText(el.value);
      }
    }

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-copy]');
      if(btn){
        copySel(btn.getAttribute('data-copy'));
        btn.textContent = 'Copied';
        setTimeout(()=>btn.textContent='Copy', 1200);
      }
    });

    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const sku = skuInput.value;
      const target = buildTarget(sku);
      if(!target) return;
      await updateUI(target);
    });

    setBookmarklet();
  </script>
</body>
</html>